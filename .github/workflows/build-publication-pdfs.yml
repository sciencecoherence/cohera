name: Publications â€¢ Build Ready PDFs

on:
workflow_dispatch:
push:
branches: [ "main" ]
paths:
- "site/publications/tex/**"
- "scripts/build_publication_pdfs.sh"
- ".github/workflows/build-publication-pdfs.yml"

permissions:
contents: write

jobs:
build-ready-publications:
name: Build ready publication PDFs
runs-on: ubuntu-latest
steps:
- name: Checkout repository
uses: actions/checkout@v4
with:
fetch-depth: 0

- name: Set up Python
uses: actions/setup-python@v5
    with:
      python-version: '3.12'

  - name: Install System & LaTeX toolchain
    run: |
      sudo apt-get update
      sudo apt-get install -y poppler-utils latexmk texlive-latex-base texlive-latex-extra texlive-fonts-recommended texlive-science

  - name: Guard path portability
    run: bash scripts/ci_guard_paths.sh

  - name: Build ready-only publication PDFs
    run: bash scripts/build_publication_pdfs.sh

  - name: Commit generated PDFs (best effort)
    run: |
      if git diff --quiet -- site/publications/pdf; then
        echo "No PDF changes to commit."
        exit 0
      fi
      git config user.name "github-actions[bot]"
      git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      git add site/publications/pdf
      git commit -m "build(publications): auto-regenerate PDF artifacts [$(date +'%d/%m/%Y')]" || true
      git pull --rebase origin main || true
      git push origin HEAD:main || echo "Push skipped (race/conflict)."
